---
title: "Scrap and clean episode transcripts"
output: html_notebook
---


Scrap and clean episode transcripts from genius.com

```{r eval=TRUE, warning=FALSE, message=FALSE}

library(httr)
library(tidytext)
library(knitr)
library(xml2)
library(rebus)
library(stringr)
library(rvest)
library(magrittr)
library(tidyverse)

```


Import data
```{r eval=TRUE, warning=FALSE, message=FALSE}

deaths.df.long <- readRDS("interim_output/characters.death.long.01.RDS")


```


```{r eval=TRUE, warning=FALSE, message=FALSE}

if(!"episode_list.RDS" %in% list.files("interim_output/")){
  
episode.list <- read_html("https://en.wikipedia.org/wiki/List_of_Game_of_Thrones_episodes")

episode.list %<>%
  html_nodes( ".summary") %>%
  html_text() %>%
  str_replace_all(pattern = rebus::or("[[:punct:]]", "[[:cntrl:]]"),
                  replacement = "")

episode.list %>%
  write_rds("interim_output/episode_list.RDS")

}else{
  
episode.list <- read_rds("interim_output/episode_list.RDS")  
  
}

```

There seem to be two different patterns in the links of genius.com
Ones end with 'script-annotated' and others just with 'annotated'.
```{r eval=TRUE, warning=FALSE, message=FALSE}

links.all.seasons.1 <- episode.list %>%
  tolower() %>%
  str_replace_all(pattern = " ", replacement = "-") %>%
  str_c("https://genius.com/Game-of-thrones", ., "annotated", sep = "-")

links.all.seasons.2 <- episode.list %>%
  tolower() %>%
  str_replace_all(pattern = " ", replacement = "-") %>%
  str_c("https://genius.com/Game-of-thrones", ., "script","annotated", sep = "-")

links.all.seasons.df <- data_frame(link_1 = links.all.seasons.1,
                                   link_2 = links.all.seasons.2)

```


Check if links are valid (not all episodes are transcribed in genius.com webpage)
Spot missing transcribed episodes.
```{r eval=TRUE, warning=FALSE, message=FALSE}

if(!"valid_transcript_links.RDS" %in% list.files("interim_output")){

valid.links.1 <- links.all.seasons.df$link_1 %>%
  map_lgl(url_success) 

valid.links.2 <- vector(mode = "logical", length = length(valid.links.1))

valid.links.2[valid.links.1 == F] <- links.all.seasons.df$link_2[valid.links.1 == F] %>%
  map_lgl(url_success)
  
links.all.seasons.df %<>%
  bind_cols(valid_links_1 = valid.links.1,
            valid_links_2 = valid.links.2)

valid.links <- if_else(links.all.seasons.df$valid_links_1 == T,
                       true = links.all.seasons.df$link_1,
                       false = if_else(links.all.seasons.df$valid_links_2 == T,
                                       true = links.all.seasons.df$link_2,
                                       false = "missing episode"))

valid.links %>%
  write_rds(path = "interim_output/valid_transcript_links.RDS")

}else{
  
  valid.links <- read_rds(path = "interim_output/valid_transcript_links.RDS")
  
}

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

(valid.links == "missing episode") %>% sum()

valid.links

```


```{r eval=TRUE, warning=FALSE, message=FALSE}

season.vector <- c(str_c("season_", rep(1:6, 10)), rep("season_7", 7)) %>% sort

episode.number.vector <- c(rep(1:10, 6), rep(1:7))

episode.list.df <- data_frame(season = season.vector,
                              episode_number = episode.number.vector,
                              episode_name = episode.list,
                              link = valid.links)

episode.list.df

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

if(!"all_transcripts.RDS" %in% list.files("interim_output/")){

all.transcripts <- episode.list.df$link[which(episode.list.df$link != "missing episode")] %>%
  map(function(x){read_html(x) %>%
  html_nodes(".lyrics p") %>%
  html_text })

 all.transcripts %>% 
   write_rds(path = "interim_output/all_transcripts.RDS")
 
}else{
  
  all.transcripts <- read_rds("interim_output/all_transcripts.RDS")
  
}
 
```

```{r eval=TRUE, warning=FALSE, message=FALSE}

all.transcripts %<>%
  map_chr(function(x){x %>% unlist %>% str_c(collapse = "_") })

episode.list.df$transcript <- NA

episode.list.df$transcript[episode.list.df$link != "missing episode"] <- all.transcripts

rm(all.transcripts)

```

Spot character names in transcripts
```{r eval=TRUE, warning=FALSE, message=FALSE}

all.characters <- episode.list.df$transcript %>%
  str_extract_all(pattern = rebus::or("[[:upper:]]+ [[:upper:]]+:", "[[:upper:]]+:")) %>%
  unlist %>% str_replace_all(pattern = ":", replacement = "") %>% unique %>% sort

all.characters

```

Careful! This is not the final count. The only purpose here should be to help data cleaning.
```{r eval=TRUE, warning=FALSE, message=FALSE}

all.characters.df <- data_frame(name = all.characters,
                                count = map_dbl(all.characters, str_count))

all.characters.df
```


patterns to remove names: all , prostitute, EVERYBODY EVERYONE

"ALL"              
  [6] "ALL THREE"         "ALL TOGETHER"

"MELISANDRE"       
[191] "MELISDANDRE" MISSANDEI?

"ALLISER"           "ALLISER THORNE"    "ALLISER THRONE"   
 [11] "ALLISTER"
 
 
 "BRAN"              "BRAND"?
 
 CROWD
 
 "DAENERYS"          "DAERNEYS" "DANERYS"  

"DARIO"             "DARRIO" 


"ED"                "EDD"  NED STARK??             

"ELARIA"            "ELLARIA"          
 [86] "ELLIA"   
 
 
 BYSTANDERS
 
 
 GREY WORM  GREYWORM
 
  PLEASE NOTE	(out)  PYCELL PYCELLE
  
  
  QYBURN QYBURNS
  
  
  RAMSAY RAMSEY
  
  
The safest thing to do is to import a list of characters and try to match transcripts to these.
Then remove unmatched characters.

https://en.wikipedia.org/wiki/List_of_Game_of_Thrones_characters








  

Spot repeated character names with two words <- double-check this process
(i.e. they appear with name + lastname or only name)
```{r eval=TRUE, warning=FALSE, message=FALSE}

two.words.names <- all.characters %>%
  str_match(pattern = "[[:upper:]]+ " %R%  rebus::capture("[[:upper:]]+")) %>%
  as_data_frame %>%
  filter(!is.na(V1) & !is.na(V2))

two.words.names

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

repeated.names <- two.words.names[two.words.names$V2 %in% all.characters,]

repeated.names %<>%
  rename(two_words_names = V1,
         one_word_names = V2)

repeated.names

```

All together? I will have to manually check the names! 

What to do with characters such as young Ned?

Do characters appear after they die? If yes, I should be careful. Look at the pattern. I don't think I want to include as participation if they appear after having died.



Try first episode


Try cleaning first episode

```{r eval=TRUE, warning=FALSE, message=FALSE}

characters.first.episode <- first.transcript %>%
  str_extract_all(pattern = rebus::or("[[:upper:]]+ [[:upper:]]+:", "[[:upper:]]+:")) %>%
  unlist %>% str_replace_all(pattern = ":", replacement = "") %>% unique %>% sort

```

Check Royce and luwin

```{r eval=TRUE, warning=FALSE, message=FALSE}

two.words.names <- characters.first.episode %>%
  str_match(pattern = "[[:upper:]]+ " %R%  rebus::capture("[[:upper:]]+")) %>%
  as_data_frame %>%
  filter(!is.na(V1) & !is.na(V2))

two.words.names

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

repeated.names <- two.words.names[two.words.names$V2 %in% characters.first.episode,]

repeated.names %<>%
  rename(two_words_names = V1,
         one_word_names = V2)

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

first.transcript %>% print()

```


First try to split each sentence with author

```{r eval=FALSE, warning=FALSE, message=FALSE}


first.transcript.split <- str_split(first.transcript, pattern = capture(rebus::or("\n[[:upper:]]+:","\n[[:upper:]]+ [[:upper:]]+:", "[[:upper:]]+:", "[[:upper:]]+ [[:upper:]]+:")) ) 


```

```{r eval=TRUE, warning=FALSE, message=FALSE}

names.speakers <- str_match_all(first.transcript, pattern = rebus::or("\n[[:upper:]]+:","\n[[:upper:]]+ [[:upper:]]+:", "[[:upper:]]+:", "[[:upper:]]+ [[:upper:]]+:") ) %>%  
  unlist %>%
  str_replace_all(pattern = rebus::or("^[[:cntrl:]]", "[[:punct:]]$"), replacement = "")

first.transcript.split <- str_split(first.transcript, pattern = capture(rebus::or("\n[[:upper:]]+:","\n[[:upper:]]+ [[:upper:]]+:", "[[:upper:]]+:", "[[:upper:]]+ [[:upper:]]+:")) ) %>%
  unlist %>%
  str_replace_all(pattern = rebus::or("\n"), replacement = "")

names.speakers %>% head(20)

first.transcript.split %>% head(6)

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

first.transcript.df <- data_frame(names_speakers = c(NA,names.speakers), 
                                  text = first.transcript.split  )

```


Replace names of repeated authors with short name

```{r eval=TRUE, warning=FALSE, message=FALSE}

first.transcript.df %<>%
  left_join(repeated.names, by = c("names_speakers" = "two_words_names")) %>%
  mutate(names_speakers = if_else(!is.na(one_word_names), 
                                  true = one_word_names,
                                  false = names_speakers)) %>%
  select(-one_word_names)

```


```{r eval=FALSE, warning=FALSE, message=FALSE}

first.transcript.df %>% knitr::kable()

first.transcript.df

```


```{r eval=TRUE, warning=FALSE, message=FALSE}

first.transcript.df %>%
  write_delim("interim_output/first_season_transcript.txt", delim = "|")

```

```{r eval=TRUE, warning=FALSE, message=FALSE}

table(first.transcript.df$names_speakers) %>%
  sort(decreasing = T)

```


